<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENTRAP</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            color: #0f0;
        }

        #screen_container {
            /* This ensures the container takes up the whole screen but doesn't overflow */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            /* This forces the emulator to fit INSIDE the window, maintaining ratio */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            image-rendering: pixelated;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border: 1px solid #0f0;
            z-index: 10;
            border-radius: 4px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="screen_container">
        <div id="status">Initializing...</div>
        <div id="emulator_target"></div>
    </div>

    <script src="https://unpkg.com/v86@latest/build/libv86.js"></script>

    <script>
        const CHUNK_PREFIX = "win95_chunk_";
        
        window.onload = async function() {
            var statusElement = document.getElementById("status");
            var container = document.getElementById("screen_container");

            try {
                // --- STEP 1: LOAD CHUNKS ---
                statusElement.innerText = "Loading System Files...";
                var buffers = [];
                // Scanning for chunks 'aa' through 'at'
                var suffixes = ["aa","ab","ac","ad","ae","af","ag","ah","ai","aj","ak","al","am","an","ao","ap","aq","ar","as","at"]; 
                
                for (let i = 0; i < suffixes.length; i++) {
                    try {
                        let response = await fetch(CHUNK_PREFIX + suffixes[i]);
                        if (!response.ok) break;
                        let blob = await response.arrayBuffer();
                        buffers.push(blob);
                    } catch (e) { break; }
                }

                if (buffers.length === 0) throw new Error("System files missing.");

                // Create the Windows 95 Hard Drive in memory
                const finalBlob = new Blob(buffers);
                const fileURL = URL.createObjectURL(finalBlob);

                // --- STEP 2: START EMULATOR ---
                statusElement.innerText = "Booting Windows 95...";
                
                var emulator = new V86({
                    screen_container: container, // Use the main container
                    memory_size: 96 * 1024 * 1024, // Bumped RAM slightly
                    vga_memory_size: 8 * 1024 * 1024,
                    bios: { url: "./seabios.bin" },
                    vga_bios: { url: "./vgabios.bin" },
                    cdrom: { url: "./entrap.iso", async: true },
                    hda: { url: fileURL, async: true },
                    autostart: true
                });

                // --- STEP 3: AUTOMATION & COUNTDOWN ---
                var booted = false;
                
                emulator.add_listener("screen-set-mode", function(is_graphical) {
                    if(is_graphical && !booted) {
                        booted = true;
                        
                        // Start a visible countdown so you know it's working
                        var secondsLeft = 60; // Wait 60s for full boot
                        var countdown = setInterval(function() {
                            secondsLeft--;
                            statusElement.innerText = "Windows Booting... Auto-launch in " + secondsLeft + "s";
                            
                            if (secondsLeft <= 0) {
                                clearInterval(countdown);
                                launchGame();
                            }
                        }, 1000);
                    }
                });

                function launchGame() {
                    statusElement.innerText = "Launching ENTRAP...";
                    
                    // 1. Open Run Dialog (Ctrl + Esc, then R)
                    // We send these slowly to make sure Windows catches them
                    emulator.keyboard_send_scancodes([0x1D, 0x01]); // Ctrl + Esc down
                    setTimeout(() => emulator.keyboard_send_scancodes([0x9D, 0x81]), 200); // Release
                    
                    setTimeout(function() {
                        emulator.keyboard_send_text("r"); // Press R
                        
                        setTimeout(function() {
                            // 2. Type command slowly character by character
                            var cmd = "D:\\ENTRAPNT.EXE\n";
                            var i = 0;
                            var typing = setInterval(function() {
                                if (i < cmd.length) {
                                    emulator.keyboard_send_text(cmd.charAt(i));
                                    i++;
                                } else {
                                    clearInterval(typing);
                                    // Hide status after command is sent
                                    setTimeout(() => { statusElement.style.display = 'none'; }, 2000);
                                }
                            }, 100); // 100ms per key
                        }, 1000);
                    }, 1000);
                }

            } catch (err) {
                statusElement.innerText = "Error: " + err.message;
                statusElement.style.color = "red";
            }
        };
    </script>
</body>
</html>
